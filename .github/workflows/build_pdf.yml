name: LaTeX Book PDF CI/CD
on:
  push:
    branches:
      - main
    paths:
      - 'book.tex'
      - 'Dockerfile'
jobs:
  build_and_commit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Cache LaTeX packages
      uses: actions/cache@v4
      with:
        path: /usr/share/texlive
        key: texlive-${{ runner.os }}-${{ hashFiles('**/Dockerfile') }}
        restore-keys: |
          texlive-${{ runner.os }}-

    - name: Install LaTeX
      run: |
        sudo apt-get update
        sudo apt-get install -y texlive-xetex texlive-fonts-recommended texlive-fonts-extra fonts-jetbrains-mono
    
    - name: Compile LaTeX
      run: xelatex -interaction=nonstopmode book.tex
    
    - name: Commit and Push PDF
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        file_pattern: book.pdf
        commit_message: 'CI: Auto-generated book.pdf from book.tex'
        branch: ${{ github.ref_name }}
        commit_user_name: GitHub Actions Bot
        commit_user_email: actions@github.com
      env:
        GITHUB_TOKEN: ${{ secrets.PAT }}

    - name: Upload PDF as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: compiled-book-pdf
        path: book.pdf
